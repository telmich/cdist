# source our functions
. $__local/lib/functions

# find our stacks and envs
export __stacks=$($DH --sysinfo=$__target_host --var=stacks | sed -e 's/,/ /g')
e -l NOTICE "stacks -> $__stacks"
export __envs=$($DH --sysinfo=$__target_host --var=envs | sed -e 's/,/ /g')
e -l NOTICE "envs -> $__envs"

# find our groups
export __groups=$($__local/lib/getGroups.pl $__target_host)
e -l NOTICE "groups -> $__groups"
e -l NOTICE "tmpdir -> $__global"

if [ $TEST_MODE -eq 1 ]; then
  # in test mode we just run the one conf/test manifest
  e "test mode enabled, sourcing test config"
  . $__conf/test
 else
  # we split config into per-env and common dirs (stacks are called out
  # within the configs themselves, usually in case statements)
  for e in $__envs $__groups $__target_host common; do
    if [ -d "$__conf/$e" ]; then
      for f in $(ls -1 $__conf/$e); do
        c=$__conf/$e/$f
        e "sourcing config $c"
        . $c
      done
    fi
  done
fi

